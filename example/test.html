<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SelfNetFS Test</title>
  <script src="./selfnetfs.js"></script>
</head>
<body>
  <script>
    'use strict';

    const API_ROOT = 'https://selfnetfs-api.home.arpa/test';

    async function makeMemory() {
      const snfs = new SNFSMemory(uuidgen, new SNFSPasswordModuleNull());
      await snfs.bootstrap('admin', 'password');
      const ses = await snfs.login({ name: 'admin', password: 'password' });
      const fs = await ses.fs();
      return { snfs, ses, fs };
    }

    async function makeHttp() {
      const snfs = new SNFSHttp();
      let ses = null;
      const session_token = localStorage.getItem('snfs_test_session_token');
      try {
        ses = await snfs.resume(session_token);
        console.log('Successfully resumed session.');
      } catch (err) {
        console.log('Couldn\'t resume, logging in again.');
        ses = await snfs.login({ api_root: API_ROOT, name: 'admin', password: 'password' });
        localStorage.setItem('snfs_test_session_token', ses.info().session_token);
      }
      await doCleanup(ses);
      const fs = await ses.fs();
      return { snfs, ses, fs };
    }

    function tenc(text) {
      return new TextEncoder().encode(text);
    }

    function tdec(data) {
      return new TextDecoder().decode(data);
    }

    async function good(handler) {
      try {
        await handler();
      } catch (err) {
        console.error(err);
      }
    }
    async function bad(message, handler) {
      try {
        await handler();
        console.error(new Error('Expected error.'));
      } catch (err) {
        if (message != err.message) {
          console.error(err);
        }
      }
    }

    async function runTests(snfs, ses, fs) {
      await good(async () => {
        // -----------------------------
        // T1 - Basic Functionality Test
        // -----------------------------
        //
        // The follwoing tests activates the most basic functionality and sets up `fs`,
        // the argument to runTests() for future tests. Be careful when updating this
        // section of tests as other sections may rely on it being in a particular state.
        await fs.writefile('/test1', tenc('test data'));
        {
          const { data } = await fs.readfile('/test1');
          if (tdec(data) != 'test data') {
            throw new Error('Unexpected data!');
          }
        }
        {
          const entries = await fs.readdir('/');
          if (entries.length != 1) {
            throw new Error('Unexpected number of entries!');
          }
        }
        await bad('File not found.', async() => {
          await fs.stat('/test2');
        });
        await fs.writefile('/test2', tenc('test2'));
        await fs.stat('/test2');
        await fs.writefile('/test1/testfile', tenc('more data'));
        {
          const entries = await fs.readdir('/');
          if (entries.length != 3) {
            throw new Error('Unexpected number of entries!');
          }
          if (entries.filter(e => e.kind == 'dir').length != 1) {
            throw new Error('Unexpected number of directories!');
          }
          if (entries.filter(e => e.kind == 'file').length != 2) {
            throw new Error('Unexpected number of files!');
          }
        }

        // ---------------------------------------
        // T2 - Test Union with User Modifications
        // ---------------------------------------
        //
        // Depends on T1
        //
        // The following tests ensure that union file systems are working and that
        // they operate in the expected manner as a user is modified.
        //
        // TODO: Test that taking access away from a fs affects acquired fs sessions.
        {
          const fsinfo = await ses.fsadd({ name: 'testing' });
          await ses.useradd({ name: 'guest', password: 'password', fs: fsinfo.fsno  });
        }
        let ses2 = await snfs.login({ api_root: API_ROOT, name: 'guest', password: 'password' });
        let fs2 = await ses2.fs();
        {
          const entries = await fs2.readdir('/');
          if (entries.length != 0) {
            throw new Error('Unexpected number of entries!');
          }
        }
        await ses.usermod(ses2.info().userno, { union: [fs.info().fsno] });
        {
          // Shouldn't see the files until you acquire the fs again.
          const entries = await fs2.readdir('/');
          if (entries.length != 0) {
            throw new Error('Unexpected number of entries!');
          }
        }
        fs2 = await ses2.fs();
        // Now you should see the files.
        {
          const entries = await fs2.readdir('/');
          if (entries.length != 3) {
            throw new Error('Unexpected number of entries!');
          }
          if (entries.filter(e => e.kind == 'dir').length != 1) {
            throw new Error('Unexpected number of directories!');
          }
          if (entries.filter(e => e.kind == 'file').length != 2) {
            throw new Error('Unexpected number of files!');
          }
        }
      });
    }

    async function basicTests() {
      const variants = [
        await makeMemory(),
        await makeHttp(),
      ];
      for (const { snfs, ses, fs } of variants) {
        console.log('Testing', snfs);
        await runTests(snfs, ses, fs);
      }
      console.log('Done.');
    }

    async function doCleanup(ses) {
      console.log('Cleaning up...');
      const detail = await ses.detail();
      for (const user of await ses.userlist()) {
        if (user.userno !== detail.user.userno) {
          console.log('Deleting user', user.userno, user.name);
          await ses.userdel(user.userno);
        }
      }
      const newfs = await ses.fsadd({ name: 'default' });
      await ses.usermod(detail.user.userno, { name: 'admin', password: 'password', fs: newfs.fsno, union: [] });
      for (const fs of await ses.fslist()) {
        if (fs.fsno != newfs.fsno) {
          console.log('Deleting fs', fs.fsno);
          await ses.fsdel(fs.fsno);
        }
      }
    }

    async function main() {
      await basicTests();
    }

    main();
  </script>
</body>
</html>
